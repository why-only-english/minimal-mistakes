---

layout: single
title: "[도커] 3. 데이터 관리 및 볼륨으로 작업하기"
toc: true
toc_sticky: true
toc_label: " "
categories: Docker_Kubernetes_실전_가이드

---

> 이미지와 컨테이너가 다양한 방식으로 어떻게 데이터를 관리하는가
볼륨은 무엇이고 어떻게 작업하는가
> 

- 컨테이너나 이미지와 로컬 파일 시스템 간에는 연결되어 있지 않음
- 이미지를 초기화할 때 로컬 폴더와 파일의 스냅샷을 복사할 수 있지만 이후에는 연결이 없어짐

### 볼륨

- 데이터를 유지하도록 하는 호스트 머신의 폴더
- 컨테이너나 이미지에 있는 게 아님
- 컨테이너 내부의 폴더를 호스트 머신 상의 컨테이너 외부 폴더와 연결 → 두 폴더의 변경 사항은 다른 폴더에 반영
    
    ➡️ 따라서, 호스트 머신에 파일을 추가하면 컨테이너 내부에서 액세스할 수 있고 컨테이너가 매핑된 경로에 파일을 추가하면 컨테이너 외부, 즉 호스트 머신에서도 사용 가능
    
- **볼륨은 컨테이너가 종료된 경우에도 지속되면 계속 존재**

```docker
// 이미지에 볼륨을 추가하고
// 그 이미지를 기반으로 실행되는 컨테이너에 데이터를 추가

VOLUME [ "/data" ]
```

- `docker volume ls` : 도커가 현재 관리 중인 모든 볼륨을 리스팅

- `docker run -v 이름:경로` : named 볼륨
    - ex) `docker run -v feedback:/app/feedback`
    - named(명명된) 볼륨을 사용하면 컨테이너가 종료된 후에도 볼륨이 유지
    - 익명 볼륨은 컨테이너가 생성될 때마다 익명 볼륨이 다시 생성되기 때문에 컨테이너가 제거되면 익명 볼륨도 사라짐 → 하나의 컨테이너에만 연결
    - named 볼륨은 하나의 컨테이너에만 연결되지 않음 → 새로운 컨테이너를 재시작한다고 해도 동일한 볼륨을 가지며 데이터가 그대로 유지됨

### 바인드 마운트

- 소스 코드에서 변경 사항이 있을 때, 이미지를 다시 빌드 하지 않으면 컨테이너에 반영되지 않음

❓ 변경 사항이 있을때마다 리빌드 → 컨테이너 실행 : 불편함

<center><img width="450" alt="image" src="https://github.com/why-only-english/Programmers/assets/114092152/7a88a6db-b4f5-40ad-944c-fab990a236e5"></center>


- 이미지에 영향을 주는 것이 아니라 컨테이너를 실행할때 바인드 마운트 설정
- 바로 가기
    - 항상 전체 경로를 복사하여 사용하고 싶지 않은 경우 바로 가기를 사용할 수 있음
    - Windows : `-v “%cd%”:/app`
    - MacOS / Linux : `-v $(pwd):/app`

<center><img width="377" alt="image" src="https://github.com/why-only-english/Programmers/assets/114092152/c0240687-ec50-43d4-a099-8411d62731a6"></center>


콜론 앞에 로컬 머신 경로가 붙으면 → 바인드 마운트

콜론 앞에 경로가 아닌 것이 붙으면 볼륨 이름 → named 볼륨

그것도 아니면 → 익명 볼륨 

### 볼륨 관리하기

- **볼륨**은 도커에 의해 관리되고 도커에 의해 관리된다는 것은 컨테이너를 실행할 때 볼륨이 존재하지 않는다면 볼륨을 생성한다는 의미
    - `docker volume create` 를 사용하여 자체적인 생성도 가능
- **바인드 마운트**는 도커에서 관리 ❌
    - 사용자가 지정한 로컬 폴더를 컨테이너 내부의 폴더에 바인딩하여 코드 변경 사항이 실행 중인 컨테이너에 자동으로 반영

### COPY

> 바인드 마운트로 바인딩하여 코드 변경 사항이 실행 중인 컨테이너에 자동으로 반영되는데 Dockerfile의 모든 항목은 `COPY` 하는 이유?
> 
- 바인드 마운드는 `docker run` 명령을 통해 실행하고 이는 개발 중에 사용하는 명령이므로 개발을 마친 뒤에는 실제로 이 컨테이너를 가져와 서버에 배포
- **프로덕션 환경, 실제로 제품을 사용하는 환경에서는 항상 코드의 스냅샷을 갖고 있는 것이 유용하기 때문에 `COPY` 명령을 유지**

### 빌드 인수 & 런타임 환경 변수

- 이미지를 빌드하거나 컨테이너를 실행할 때 외부에서 특정 데이터를 전달 가능
- Dockerfile이나 소스 코드에서 모든 것을 하드 코딩할 필요가 ❌
- 컨테이너를 실행할 때 이를 구성할 수 있음
    - `--env-file ./.env`
    - `--build-arg`